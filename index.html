<!-- Local Mode -->

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Collaborative Task Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item {
            transition: all 0.2s ease-in-out;
        }
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .completed-task p, .completed-task .text-gray-400 {
            text-decoration: line-through;
            color: #6b7280;
        }
        html.dark .priority-urgent { border-left: 4px solid #ef4444; }
        html.dark .priority-high { border-left: 4px solid #f97316; }
        html.dark .priority-medium { border-left: 4px solid #eab308; }
        html.dark .priority-low { border-left: 4px solid #3b82f6; }
        html.light .priority-urgent { border-left: 4px solid #ef4444; }
        html.light .priority-high { border-left: 4px solid #f97316; }
        html.light .priority-medium { border-left: 4px solid #eab308; }
        html.light .priority-low { border-left: 4px solid #3b82f6; }


        .modal-enter-active, .confirm-enter-active, .popup-enter-active { animation: fadeIn 0.3s ease-out; }
        .modal-leave-active, .confirm-leave-active, .popup-leave-active { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        html.dark input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        
        .skeleton-loader { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }

        .dragging { opacity: 0.5; transform: rotate(3deg); }
        .drag-over { border: 2px dashed #4f46e5; }
        .task-dropped { animation: flash 0.5s ease-out; }
        @keyframes flash { from { background-color: rgba(79, 70, 229, 0.3); } }

        /* Tooltip styles */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; width: 120px; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        html.dark .tooltip .tooltip-text { background-color: #111827; color: #fff; }
        html.light .tooltip .tooltip-text { background-color: #f9fafb; color: #1f2937; border: 1px solid #e5e7eb; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div class="container mx-auto max-w-7xl mt-8 px-4">
        <div id="error-overlay" class="fixed inset-0 bg-red-900/90 z-[100] flex-col items-center justify-center text-center p-8 hidden">
             <h2 class="text-3xl font-bold text-white mb-4">Configuration Error</h2>
             <p class="text-red-200 max-w-2xl">Firebase configuration is missing or invalid. Please check the console and the initial script tag in `index.html` to ensure your Firebase config is correctly set up.</p>
        </div>

        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Task Dashboard</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Your personal & collaborative workspace.</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="live-clock" class="text-lg font-mono bg-white dark:bg-gray-900/50 px-4 py-2 rounded-lg text-gray-700 dark:text-gray-300 shadow-sm"></div>
                <button id="add-task-modal-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    New Task
                </button>
            </div>
        </header>
        
        <!-- Controls -->
        <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <input type="search" id="search-input" placeholder="Search tasks..." class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                <select id="priority-filter" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                    <option value="all">All Priorities</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                 <button id="import-btn" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip"><span class="tooltip-text">Import from File</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></button>
                 <input type="file" id="import-file-input" class="hidden" accept=".json">
                 <button id="export-btn" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip"><span class="tooltip-text">Export to File</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                 <button id="theme-toggle-btn" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip"><span class="tooltip-text">Toggle Theme</span><svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg></button>
            </div>
        </div>

        <main>
            <!-- Task Columns -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- To Do Column -->
                <div class="bg-gray-200 dark:bg-gray-800/50 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white p-4 border-b-2 border-indigo-500">To Do (<span id="todo-count">0</span>)</h2>
                    <div id="todo-list" class="task-column p-4 space-y-4 h-[60vh] overflow-y-auto" data-status="todo">
                        <div class="skeleton-item h-24 skeleton-loader"></div>
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-gray-200 dark:bg-gray-800/50 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white p-4 border-b-2 border-yellow-500">In Progress (<span id="inprogress-count">0</span>)</h2>
                    <div id="inprogress-list" class="task-column p-4 space-y-4 h-[60vh] overflow-y-auto" data-status="inprogress">
                        <div class="skeleton-item h-24 skeleton-loader"></div>
                    </div>
                </div>

                <!-- Completed Column -->
                <div class="bg-gray-200 dark:bg-gray-800/50 rounded-xl">
                     <h2 class="text-xl font-bold text-gray-800 dark:text-white p-4 border-b-2 border-green-500">Completed (<span id="completed-count">0</span>)</h2>
                    <div id="completed-list" class="task-column p-4 space-y-4 h-[60vh] overflow-y-auto" data-status="completed">
                        <div class="skeleton-item h-24 skeleton-loader"></div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-500 my-12">
            <p>Advanced Dashboard Interface with Real-Time Reminders</p>
        </footer>
    </div>
    
    <!-- Modals and Popups -->
    <div id="task-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Create New Task</h2>
            <form id="task-form">
                <div class="mb-4">
                    <label for="task-title" class="block text-gray-600 dark:text-gray-400 mb-2">Title</label>
                    <input type="text" id="task-title" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-3" required>
                </div>
                <div class="mb-4">
                    <label for="task-desc" class="block text-gray-600 dark:text-gray-400 mb-2">Description (Optional)</label>
                    <textarea id="task-desc" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-3" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-start-time" class="block text-gray-600 dark:text-gray-400 mb-2">Start Date & Time</label>
                        <input type="datetime-local" id="task-start-time" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-3">
                    </div>
                    <div>
                        <label for="task-due-date" class="block text-gray-600 dark:text-gray-400 mb-2">Due Date & Time</label>
                        <input type="datetime-local" id="task-due-date" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-3">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="task-priority" class="block text-gray-600 dark:text-gray-400 mb-2">Priority</label>
                        <select id="task-priority" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-3">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                         <label for="task-tags" class="block text-gray-600 dark:text-gray-400 mb-2">Tags (comma separated)</label>
                        <input type="text" id="task-tags" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-3" placeholder="e.g. work, personal">
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all">
            <h3 id="confirm-title" class="text-xl font-semibold mb-4 text-gray-900 dark:text-white"></h3>
            <p id="confirm-text" class="text-gray-500 dark:text-gray-400 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>
    
    <div id="reminder-popup" class="fixed bottom-5 right-5 bg-indigo-600 text-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-[101] hidden transform transition-all">
        <h3 id="reminder-title" class="text-lg font-bold mb-2"></h3>
        <p id="reminder-text" class="mb-4"></p>
        <div class="flex justify-end gap-4">
            <button id="snooze-reminder-btn" class="bg-white/20 hover:bg-white/30 font-bold py-2 px-4 rounded-lg">Snooze 5m</button>
            <button id="start-task-btn" class="bg-white text-indigo-600 font-bold py-2 px-4 rounded-lg">Start Task Now</button>
        </div>
    </div>
    
    <div id="done-popup" class="fixed bottom-5 right-5 bg-blue-600 text-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-[101] hidden transform transition-all">
        <h3 id="done-title" class="text-lg font-bold mb-2">Time's Up!</h3>
        <p id="done-text" class="mb-4"></p>
        <div class="flex justify-end gap-4">
            <button id="snooze-done-btn" class="bg-white/20 hover:bg-white/30 font-bold py-2 px-4 rounded-lg">Snooze 5m</button>
            <button id="done-task-btn" class="bg-white text-blue-600 font-bold py-2 px-4 rounded-lg">Mark as Done</button>
        </div>
    </div>

    <div id="motivation-popup" class="fixed bottom-5 left-5 bg-green-600 text-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-[101] hidden transform transition-all">
        <div class="flex items-start">
            <svg class="w-8 h-8 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            <div>
                 <h3 class="text-lg font-bold mb-2">Motivation Boost!</h3>
                 <p id="motivation-text" class="mb-4"></p>
            </div>
             <button id="close-motivation-btn" class="ml-4 flex-shrink-0 text-white/70 hover:text-white">&times;</button>
        </div>
    </div>
    
    <audio id="notification-sound" src="data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaW5nIENTUkFQX1NGQkxPTkdfRERFRUxFSERERERERERETnsrQkFERA==/veL/CEgKGDBwgYRAwAAB8Bjb93x97y//x93/eP/yL7//0ft/23/9f/+v/9/3/8//5s+LdJHcAAAAAAAABQFAAFUDIAGwAGCdAFABqICgA8AACABpY2FsbWVudABCaW5nIENTUkFQX1NGQkxPTkdfRERFRUxFSERERERERERETnsrQkFERA==/veL/CEgKGDBwgYRAwAAB8Bjb93x97y//x93/eP/yL7//0ft/23/9f/+v/9/3/8//5s+LdJHcAAAAAAAABQFAAFUDIAGwAGCdAFABqICgA8AACABpY2FsbWVudABCaW5nIENTUkFQX1NGQkxPTkdfRERFRUxFSERERERERERETnsrQkFERA=="></audio>
    
    <script>
      // IMPORTANT: Yahan apni Firebase Project ki details daalein.
      // Agar aap ise public GitHub repo mein daal rahe hain, to in values ko khali chhod dein.
      // App a_p_n_e aap Local Storage mode mein chala jayega.
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      // Is code ko na badlein.
      const __firebase_config = JSON.stringify(firebaseConfig);
      const __app_id = firebaseConfig.projectId;
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, writeBatch, query, where, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const App = {
            db: null,
            auth: null,
            userId: null,
            appId: 'default-app-id',
            tasks: [],
            unsubscribe: null,
            reminderInterval: null,
            motivationInterval: null,
            elements: {},

            async init() {
                this.cacheElements();
                this.initFirebase();
                this.bindEvents();
                this.startClock();
                this.ui.applyTheme(localStorage.getItem('theme') || 'dark');
            },

            cacheElements() {
                this.elements = {
                    errorOverlay: document.getElementById('error-overlay'),
                    todoList: document.getElementById('todo-list'),
                    inprogressList: document.getElementById('inprogress-list'),
                    completedList: document.getElementById('completed-list'),
                    taskColumns: document.querySelectorAll('.task-column'),
                    todoCount: document.getElementById('todo-count'),
                    inprogressCount: document.getElementById('inprogress-count'),
                    completedCount: document.getElementById('completed-count'),
                    liveClock: document.getElementById('live-clock'),
                    addTaskModalBtn: document.getElementById('add-task-modal-btn'),
                    taskModal: document.getElementById('task-modal'),
                    taskForm: document.getElementById('task-form'),
                    modalTitle: document.getElementById('modal-title'),
                    cancelBtn: document.getElementById('cancel-btn'),
                    taskTitleInput: document.getElementById('task-title'),
                    taskDescInput: document.getElementById('task-desc'),
                    taskPriorityInput: document.getElementById('task-priority'),
                    taskDueDateInput: document.getElementById('task-due-date'),
                    taskStartTimeInput: document.getElementById('task-start-time'),
                    taskTagsInput: document.getElementById('task-tags'),
                    confirmModal: document.getElementById('confirm-modal'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmText: document.getElementById('confirm-text'),
                    confirmActionBtn: document.getElementById('confirm-action-btn'),
                    confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
                    reminderPopup: document.getElementById('reminder-popup'),
                    reminderTitle: document.getElementById('reminder-title'),
                    reminderText: document.getElementById('reminder-text'),
                    startTaskBtn: document.getElementById('start-task-btn'),
                    snoozeReminderBtn: document.getElementById('snooze-reminder-btn'),
                    donePopup: document.getElementById('done-popup'),
                    doneTitle: document.getElementById('done-title'),
                    doneText: document.getElementById('done-text'),
                    doneTaskBtn: document.getElementById('done-task-btn'),
                    snoozeDoneBtn: document.getElementById('snooze-done-btn'),
                    motivationPopup: document.getElementById('motivation-popup'),
                    motivationText: document.getElementById('motivation-text'),
                    closeMotivationBtn: document.getElementById('close-motivation-btn'),
                    notificationSound: document.getElementById('notification-sound'),
                    searchInput: document.getElementById('search-input'),
                    priorityFilter: document.getElementById('priority-filter'),
                    themeToggleBtn: document.getElementById('theme-toggle-btn'),
                    themeIcon: document.getElementById('theme-icon'),
                    importBtn: document.getElementById('import-btn'),
                    exportBtn: document.getElementById('export-btn'),
                    importFileInput: document.getElementById('import-file-input'),
                };
            },

            startClock() {
                if (!this.elements.liveClock) return;
                setInterval(() => {
                    this.elements.liveClock.textContent = new Date().toLocaleTimeString();
                }, 1000);
            },
            
            initFirebase() {
                 try {
                    const firebaseConfigJSON = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                    this.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (!firebaseConfigJSON || !JSON.parse(firebaseConfigJSON).apiKey || JSON.parse(firebaseConfigJSON).apiKey === "YOUR_API_KEY") {
                         console.warn("Firebase not configured. Falling back to Local Storage.");
                         this.ui.showToast("Using local mode. Data will be saved in your browser.", 'info');
                         this.useLocalStorage = true;
                         this.loadTasks();
                         return;
                    }
                    
                    const firebaseConfig = JSON.parse(firebaseConfigJSON);
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    enableIndexedDbPersistence(this.db)
                        .catch((err) => {
                            if (err.code == 'failed-precondition') console.warn("Firebase persistence failed: Multiple tabs open?");
                            else if (err.code == 'unimplemented') console.warn("Firebase persistence not available in this browser.");
                        });
                    this.auth = getAuth(app);
                    onAuthStateChanged(this.auth, (user) => {
                        if (user) {
                            this.userId = user.uid;
                            this.loadTasks();
                        } else { this.signIn(); }
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.elements.errorOverlay.classList.remove('hidden');
                    this.elements.errorOverlay.classList.add('flex');
                }
            },
            
            async signIn() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(this.auth, __initial_auth_token);
                    } else { await signInAnonymously(this.auth); }
                } catch (error) { console.error("Authentication failed:", error); }
            },

            bindEvents() {
                this.elements.addTaskModalBtn.addEventListener('click', () => this.ui.openModal());
                this.elements.cancelBtn.addEventListener('click', () => this.ui.closeModal());
                this.elements.taskModal.addEventListener('click', (e) => { if (e.target === this.elements.taskModal) this.ui.closeModal(); });
                this.elements.taskForm.addEventListener('submit', this.handleAddTask.bind(this));
                document.body.addEventListener('click', this.handleTaskListClick.bind(this));
                this.elements.confirmCancelBtn.addEventListener('click', () => this.ui.closeConfirmModal());
                this.elements.closeMotivationBtn.addEventListener('click', () => this.ui.hideMotivationPopup());
                this.elements.searchInput.addEventListener('input', () => this.renderAll());
                this.elements.priorityFilter.addEventListener('change', () => this.renderAll());
                this.elements.themeToggleBtn.addEventListener('click', () => this.ui.toggleTheme());
                this.elements.exportBtn.addEventListener('click', () => this.data.exportTasks());
                this.elements.importBtn.addEventListener('click', () => this.elements.importFileInput.click());
                this.elements.importFileInput.addEventListener('change', (e) => this.data.importTasks(e));

                this.elements.taskColumns.forEach(column => {
                    column.addEventListener('dragover', e => { e.preventDefault(); const draggingEl = document.querySelector('.dragging'); if (draggingEl) column.classList.add('drag-over'); });
                    column.addEventListener('dragleave', e => { e.preventDefault(); column.classList.remove('drag-over'); });
                    column.addEventListener('drop', e => {
                        e.preventDefault();
                        column.classList.remove('drag-over');
                        const taskId = e.dataTransfer.getData('text/plain');
                        const taskEl = document.querySelector(`[data-id="${taskId}"]`);
                        if (taskEl) {
                           taskEl.classList.add('task-dropped');
                           setTimeout(() => taskEl.classList.remove('task-dropped'), 500);
                        }

                        const newStatus = column.dataset.status;
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task && task.status !== newStatus) {
                            const updates = { status: newStatus };
                            updates.completed = newStatus === 'completed';
                            if(newStatus === 'inprogress') updates.isStarted = true;
                            this.updateTask(taskId, updates);
                        }
                    });
                });
            },
            
            getTasksCollection() { return collection(this.db, `/artifacts/${this.appId}/public/data/tasks`); },
            
            loadTasks() {
                this.ui.showLoader();
                if(this.useLocalStorage) {
                    const storedTasks = localStorage.getItem('ai_dashboard_tasks_local');
                    this.tasks = storedTasks ? JSON.parse(storedTasks) : [];
                    this.renderAll();
                    this.ui.hideLoader();
                    this.reminders.start();
                    this.motivation.start();
                    return;
                }
                if (this.unsubscribe) this.unsubscribe();
                const q = query(this.getTasksCollection());
                this.unsubscribe = onSnapshot(q, (querySnapshot) => {
                    this.tasks = [];
                    querySnapshot.forEach((doc) => this.tasks.push({ id: doc.id, ...doc.data() }));
                    this.renderAll();
                    this.ui.hideLoader();
                    this.reminders.start();
                    this.motivation.start();
                }, (error) => { console.error("Error loading tasks: ", error); this.ui.hideLoader(); });
            },

            async addTask(taskData) {
                if (!taskData.title.trim()) return;
                const newTask = { ...taskData, id: Date.now().toString(), status: 'todo', completed: false, createdAt: new Date().toISOString(), isStarted: false, snoozedUntil: null, dueSnoozedUntil: null, runningOutSnoozedUntil: null };
                if (this.useLocalStorage) {
                    this.tasks.push(newTask);
                    this.data.saveLocal();
                } else {
                    try { await addDoc(this.getTasksCollection(), newTask); } catch (error) { console.error("Error adding task:", error); }
                }
            },

            async updateTask(id, updates) {
                if (this.useLocalStorage) {
                    const taskIndex = this.tasks.findIndex(t => t.id === id);
                    if (taskIndex > -1) {
                        this.tasks[taskIndex] = { ...this.tasks[taskIndex], ...updates };
                        this.data.saveLocal();
                    }
                } else {
                    try { const taskRef = doc(this.db, `/artifacts/${this.appId}/public/data/tasks/${id}`); await updateDoc(taskRef, updates); } catch (error) { console.error("Error updating task:", error); }
                }
            },

            async deleteTask(id) {
                if(this.useLocalStorage) {
                    this.tasks = this.tasks.filter(task => task.id !== id);
                    this.data.saveLocal();
                } else {
                    try { const taskRef = doc(this.db, `/artifacts/${this.appId}/public/data/tasks/${id}`); await deleteDoc(taskRef); } catch (error) { console.error("Error deleting task:", error); }
                }
            },
            
            handleAddTask(event) {
                event.preventDefault();
                const taskData = {
                    title: this.elements.taskTitleInput.value, description: this.elements.taskDescInput.value,
                    priority: this.elements.taskPriorityInput.value, dueDate: this.elements.taskDueDateInput.value,
                    startTime: this.elements.taskStartTimeInput.value,
                    tags: this.elements.taskTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean)
                };
                this.addTask(taskData);
                this.elements.taskForm.reset();
                this.ui.closeModal();
            },

            handleTaskListClick(event) {
                const target = event.target;
                const taskElement = target.closest('.task-item');
                if (!taskElement) return;
                const taskId = taskElement.dataset.id;
                
                if (target.matches('.task-checkbox')) {
                    const isCompleted = target.checked;
                    this.updateTask(taskId, { completed: isCompleted, status: isCompleted ? 'completed' : 'todo' });
                } else if (target.matches('.delete-btn') || target.closest('.delete-btn')) {
                    this.ui.openConfirmModal('Delete Task?', 'Are you sure you want to delete this task?', () => this.deleteTask(taskId));
                }
            },

            renderAll() { this.renderTasks(); this.updateCounts(); },

            renderTasks() {
                const tasksByStatus = { todo: [], inprogress: [], completed: [] };
                
                const filteredTasks = this.data.getFilteredTasks();

                filteredTasks.forEach(task => {
                    const status = task.completed ? 'completed' : (task.status || 'todo');
                    if(tasksByStatus[status]) tasksByStatus[status].push(task);
                });

                Object.keys(tasksByStatus).forEach(status => {
                    const listEl = this.elements[`${status}List`];
                    if(!listEl) return;
                    listEl.innerHTML = '';
                    if (tasksByStatus[status].length === 0) {
                        const message = status === 'todo' ? "No tasks here. Add a new task to get started!" : "No tasks here.";
                        listEl.innerHTML = `<div class="text-center p-8 text-gray-500 dark:text-gray-400">${message}</div>`;
                    } else {
                        tasksByStatus[status].forEach(task => listEl.appendChild(this.createTaskElement(task)));
                    }
                });
            },

            createTaskElement(task) {
                const div = document.createElement('div');
                div.className = `task-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg flex items-start gap-4 ${task.completed ? 'opacity-50' : ''} priority-${task.priority || 'low'}`;
                div.dataset.id = task.id;
                div.draggable = !task.completed;
                div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', task.id); e.currentTarget.classList.add('dragging'); });
                div.addEventListener('dragend', (e) => e.currentTarget.classList.remove('dragging'));

                const tagsHTML = (task.tags || []).map(tag => `<span class="bg-gray-200 dark:bg-gray-600 text-xs px-2 py-1 rounded-full">${this.escapeHTML(tag)}</span>`).join(' ');
                
                let timeInfoHTML = '';
                if (task.startTime) {
                    const startTime = new Date(task.startTime);
                    timeInfoHTML += `<div class="mt-2 flex items-center text-sm text-gray-500 dark:text-gray-400"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Starts: ${startTime.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})}</span></div>`;
                }
                if (task.dueDate) {
                    const dueDateTime = new Date(task.dueDate);
                    const isOverdue = !task.completed && dueDateTime < new Date();
                    timeInfoHTML += `<div class="mt-2 flex items-center text-sm ${isOverdue ? 'text-red-500 dark:text-red-400' : 'text-gray-500 dark:text-gray-400'}"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Due: ${dueDateTime.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})} ${isOverdue ? '(Overdue)' : ''}</span></div>`;
                }

                div.innerHTML = `<input type="checkbox" class="task-checkbox h-6 w-6 mt-1 rounded-full border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-indigo-500 focus:ring-indigo-600 cursor-pointer flex-shrink-0" ${task.completed ? 'checked' : ''}><div class="flex-grow"><div class="flex justify-between items-start gap-2"><div class="flex-grow ${task.completed ? 'completed-task' : ''}"><p class="font-semibold text-lg text-gray-900 dark:text-gray-100 break-words">${this.escapeHTML(task.title)}</p><p class="text-gray-600 dark:text-gray-400 break-words">${this.escapeHTML(task.description)}</p></div><button class="delete-btn text-gray-400 dark:text-gray-500 hover:text-red-500 transition ml-2 flex-shrink-0 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div><div class="flex flex-wrap gap-2 mt-3">${tagsHTML}</div><div class="flex flex-col sm:flex-row sm:flex-wrap sm:gap-x-4 sm:gap-y-2">${timeInfoHTML}</div></div>`;
                return div;
            },
            
            updateCounts() {
                this.elements.todoCount.textContent = this.tasks.filter(t => !t.completed && (t.status === 'todo' || !t.status)).length;
                this.elements.inprogressCount.textContent = this.tasks.filter(t => !t.completed && t.status === 'inprogress').length;
                this.elements.completedCount.textContent = this.tasks.filter(t => t.completed).length;
            },
            
            escapeHTML(str) {
                if (!str) return '';
                const p = document.createElement("p");
                p.textContent = str;
                return p.innerHTML;
            },

            notifications: {
                permission: "default",
                requestPermission() { if ('Notification' in window && Notification.permission !== 'denied') { Notification.requestPermission().then(status => this.permission = status); } },
                send(title, body) { if (this.permission === "granted") { new Notification(title, { body }); App.elements.notificationSound.play().catch(e => {}); } }
            },
            
            motivation: {
                quotes: ["The secret of getting ahead is getting started.", "Believe you can and you're halfway there.", "The only way to do great work is to love what you do.", "Well done is better than well said.", "A little progress each day adds up to big results.", "Don't watch the clock; do what it does. Keep going.", "The future depends on what you do today."],
                start() {
                    if (App.motivationInterval) clearTimeout(App.motivationInterval);
                    const showNextQuote = () => { this.showQuote(); const randomDelay = Math.random() * (900000 - 300000) + 300000; App.motivationInterval = setTimeout(showNextQuote, randomDelay); };
                    const initialDelay = Math.random() * (180000 - 60000) + 60000;
                    App.motivationInterval = setTimeout(showNextQuote, initialDelay);
                    document.addEventListener('visibilitychange', () => { clearTimeout(App.motivationInterval); if(!document.hidden) App.motivationInterval = setTimeout(showNextQuote, initialDelay); });
                },
                showQuote() { if (document.hidden || document.querySelector('.popup-enter-active')) return; const quote = this.quotes[Math.floor(Math.random() * this.quotes.length)]; App.ui.showMotivationPopup(quote); }
            },

            reminders: {
                start() { if (App.reminderInterval) clearInterval(App.reminderInterval); App.reminderInterval = setInterval(this.check.bind(this), 15000); },
                check() {
                    if (document.querySelector('.popup-enter-active')) return;
                    const now = new Date();
                    const tasksToCheck = App.tasks.filter(task => !task.completed);
                    let taskToShowPopup = null, popupType = null;
                    for (const task of tasksToCheck) {
                        const dueDateTime = task.dueDate ? new Date(task.dueDate) : null;
                        const startTime = task.startTime ? new Date(task.startTime) : null;
                        if (dueDateTime && dueDateTime < now) { if (task.dueSnoozedUntil && new Date(task.dueSnoozedUntil) > now) continue; taskToShowPopup = task; popupType = 'due'; break; }
                        if (startTime && startTime < now && !task.isStarted) { if (task.snoozedUntil && new Date(task.snoozedUntil) > now) continue; taskToShowPopup = task; popupType = 'overdue'; break; }
                        if (startTime && !task.isStarted) { const diffMinutes = (startTime - now) / (1000 * 60); if (diffMinutes <= 5 && diffMinutes >= 0) { if (task.snoozedUntil && new Date(task.snoozedUntil) > now) continue; taskToShowPopup = task; popupType = 'starting'; break;}}
                    }
                    if (taskToShowPopup) {
                        if (popupType === 'due') App.ui.showDonePopup(taskToShowPopup);
                        else if (popupType === 'overdue') App.ui.showReminderPopup(taskToShowPopup, true);
                        else if (popupType === 'starting') App.ui.showReminderPopup(taskToShowPopup, false);
                    }
                },
                startTask(taskId) { App.updateTask(taskId, { status: 'inprogress', isStarted: true }); App.ui.hideReminderPopup(); },
                snoozeStart(taskId) { App.updateTask(taskId, { snoozedUntil: new Date(Date.now() + 5 * 60 * 1000).toISOString() }); App.ui.hideReminderPopup(); },
                completeTask(taskId) { App.updateTask(taskId, { completed: true, status: 'completed' }); App.ui.hideDonePopup(); },
                snoozeDue(taskId) { App.updateTask(taskId, { dueSnoozedUntil: new Date(Date.now() + 5 * 60 * 1000).toISOString() }); App.ui.hideDonePopup(); }
            },

            data: {
                saveLocal() { localStorage.setItem('ai_dashboard_tasks_local', JSON.stringify(App.tasks)); App.renderAll(); },
                getFilteredTasks() {
                    let tasks = App.tasks;
                    const searchTerm = App.elements.searchInput.value.toLowerCase();
                    const priority = App.elements.priorityFilter.value;

                    if (searchTerm) tasks = tasks.filter(task => task.title.toLowerCase().includes(searchTerm) || (task.description && task.description.toLowerCase().includes(searchTerm)));
                    if (priority !== 'all') tasks = tasks.filter(task => task.priority === priority);
                    return tasks;
                },
                exportTasks() {
                    const dataStr = JSON.stringify(App.tasks, null, 2);
                    const blob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'tasks_backup.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    App.ui.showToast("Tasks exported successfully!", "success");
                },
                importTasks(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedTasks = JSON.parse(e.target.result);
                            if (Array.isArray(importedTasks)) {
                                App.ui.openConfirmModal("Import Tasks?", "This will overwrite all current tasks. Are you sure?", () => {
                                    App.tasks = importedTasks;
                                    App.data.saveLocal();
                                    App.ui.showToast("Tasks imported successfully!", "success");
                                });
                            } else { throw new Error("Invalid file format"); }
                        } catch (err) { App.ui.showToast("Error importing file. Invalid format.", "error"); }
                    };
                    reader.readAsText(file);
                    event.target.value = null; // Reset file input
                }
            },
            
            ui: {
                showLoader() { document.querySelectorAll('.skeleton-item').forEach(el => el.classList.remove('hidden')); },
                hideLoader() { document.querySelectorAll('.skeleton-item').forEach(el => el.classList.add('hidden')); },
                openModal() {
                    App.elements.taskForm.reset();
                    const now = new Date(); now.setMinutes(now.getMinutes() + 5);
                    const localISOTime = new Date(now - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                    App.elements.taskStartTimeInput.value = localISOTime;
                    App.elements.taskModal.classList.remove('hidden'); App.elements.taskModal.classList.add('flex', 'modal-enter-active');
                },
                closeModal() {
                    App.elements.taskModal.classList.remove('modal-enter-active'); App.elements.taskModal.classList.add('modal-leave-active');
                    setTimeout(() => App.elements.taskModal.classList.add('hidden'), 300);
                },
                openConfirmModal(title, text, onConfirm) {
                    App.elements.confirmTitle.textContent = title; App.elements.confirmText.textContent = text;
                    App.elements.confirmActionBtn.onclick = () => { onConfirm(); this.closeConfirmModal(); };
                    App.elements.confirmModal.classList.remove('hidden'); App.elements.confirmModal.classList.add('flex', 'confirm-enter-active');
                },
                closeConfirmModal() {
                    App.elements.confirmModal.classList.remove('confirm-enter-active'); App.elements.confirmModal.classList.add('confirm-leave-active');
                    setTimeout(() => App.elements.confirmModal.classList.add('hidden'), 300);
                },
                showReminderPopup(task, isOverdue = false) {
                    if(isOverdue) { 
                        App.elements.reminderTitle.textContent = 'Time Running Out, Start your Task ASAP!'; 
                        App.elements.reminderPopup.classList.replace('bg-indigo-600', 'bg-orange-600'); 
                    } else { 
                        App.elements.reminderTitle.textContent = 'Task Starting Soon!'; 
                        App.elements.reminderPopup.classList.replace('bg-orange-600', 'bg-indigo-600'); 
                    }
                    const message = `Task: "${App.escapeHTML(task.title)}"`;
                    App.notifications.send(App.elements.reminderTitle.textContent, message); App.elements.reminderText.textContent = message;
                    App.elements.startTaskBtn.onclick = () => App.reminders.startTask(task.id);
                    App.elements.snoozeReminderBtn.onclick = () => App.reminders.snoozeStart(task.id);
                    App.elements.reminderPopup.classList.remove('hidden', 'popup-leave-active'); App.elements.reminderPopup.classList.add('popup-enter-active', 'flex');
                },
                hideReminderPopup() {
                    App.elements.reminderPopup.classList.remove('popup-enter-active'); App.elements.reminderPopup.classList.add('popup-leave-active');
                    setTimeout(() => App.elements.reminderPopup.classList.add('hidden'), 300);
                },
                showDonePopup(task) {
                    const message = `Task: "${App.escapeHTML(task.title)}"`; App.notifications.send("Time's Up!", message);
                    App.elements.doneText.textContent = message; App.elements.doneTaskBtn.onclick = () => App.reminders.completeTask(task.id);
                    App.elements.snoozeDoneBtn.onclick = () => App.reminders.snoozeDue(task.id);
                    App.elements.donePopup.classList.remove('hidden', 'popup-leave-active'); App.elements.donePopup.classList.add('popup-enter-active', 'flex');
                },
                hideDonePopup() {
                    App.elements.donePopup.classList.remove('popup-enter-active'); App.elements.donePopup.classList.add('popup-leave-active');
                    setTimeout(() => App.elements.donePopup.classList.add('hidden'), 300);
                },
                showMotivationPopup(quote) {
                    App.elements.motivationText.textContent = quote; App.elements.motivationPopup.classList.remove('hidden', 'popup-leave-active');
                    App.elements.motivationPopup.classList.add('popup-enter-active', 'flex');
                },
                hideMotivationPopup() {
                    App.elements.motivationPopup.classList.remove('popup-enter-active'); App.elements.motivationPopup.classList.add('popup-leave-active');
                    setTimeout(() => App.elements.motivationPopup.classList.add('hidden'), 300);
                },
                 toggleTheme() {
                    const currentTheme = localStorage.getItem('theme') || 'dark';
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    this.applyTheme(newTheme);
                    localStorage.setItem('theme', newTheme);
                },
                applyTheme(theme) {
                    const htmlEl = document.documentElement;
                    if(theme === 'light') {
                        htmlEl.classList.remove('dark');
                        htmlEl.classList.add('light');
                        App.elements.themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`; // Moon
                    } else {
                        htmlEl.classList.remove('light');
                        htmlEl.classList.add('dark');
                        App.elements.themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`; // Sun
                    }
                },
                 showToast(message, type = 'info') {
                    const colors = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600' };
                    const toast = document.createElement('div');
                    toast.className = `fixed top-5 right-5 p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 ease-in-out ${colors[type]}`;
                    toast.textContent = message;
                    toast.style.transform = 'translateX(120%)';
                    document.body.appendChild(toast);
                    setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
                    setTimeout(() => { toast.style.transform = 'translateX(120%)'; toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>
